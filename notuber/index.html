<!DOCTYPE html>
<html>

<head>
    <title>Black Car Service</title>
    <link rel="stylesheet" href="style.css"/>
    <meta charset="utf-8" />


    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDbnKWhNaXjq-ChDKgDnt5P2jaa8YGP_TM&callback=myMap"></script>

    <script>
    var myLat = 42.405405599999995;
    var myLng = -71.12140029999999;
    var me;
    var mapProp = {
        center: me,
        zoom: 12
    };
    var map;
    var marker;
    var infowindow;
    var me_icon = "https://cdn4.iconfinder.com/data/icons/ionicons/512/icon-person-128.png"

    function myMap () {
        map = new google.maps.Map(document.getElementById("map"), mapProp);
        get_location();
        map.panTo(new google.maps.LatLng(42.405405599999995, -71.12140029999999));
        loadOthers();
    }


    function get_location() {
        if (navigator.geolocation) {
            //navigator.geolocation.getCurrentPosition(print);
            navigator.geolocation.getCurrentPosition(display);
        } else { 
            document.getElementById("location").innerHTML = "Geolocation is not supported by this browser.";
        }
    }

    function print(position){
        document.getElementById("location").innerHTML += '<p>' + "Latitude: " + position.coords.latitude + 
        "<br>Longitude: " + position.coords.longitude + '</p>'; 

    }

    function display(position) {
        myLat = position.coords.latitude;
        myLng = position.coords.longitude;
        render_map();
    }

    function render_map() {
        
        me = new google.maps.LatLng(myLat, myLng);
        document.getElementById("location").innerHTML += '<p>' + myLat + ' 12 ' + myLng + '</p>';
        
        // Update map and go there...
        map.panTo(me);
        /*me_icon.style.width = '20px';
        me_icon.style.height = '20px';*/

        // Create a marker
        marker = new google.maps.Marker({
            position: me,
            title: "Here I Am!",
            icon: me_icon
        });
        marker.setMap(map);


        //DEFINE INFO WINDOW SOMEWHERE
        google.maps.event.addListener(marker, 'click', function() {
            infowindow.setContent(marker.title);
            infowindow.open(map, marker);
        });

    }

    function loadOthers() {
        request = new XMLHttpRequest();
        request.open("POST", "https://defense-in-derpth.herokuapp.com/submit", true);

        var params = "username=ImjNJW4n&lat=" + myLat + "&lng=" + myLng;
        console.log(params);

        request.setRequestHeader("Content-type", "application/x-www-form-urlencoded");

        request.onreadystatechange = function() {
            var response = request.responseText;
            //console.log(response);

            var responseObject = JSON.parse(response);
            //if (responseObject.passengers.length) -- switch between passengers and cars based on response
            //console.log(list.passengers.length);
            var list = responseObject.passengers;
            for (var i = 0; i < list.length; i++){
                var user = list[i];
                //console.log(list[i].username);
                addToMap(user.lat, user.lng, user.username);
            }
            //document.getElementById("location").innerHTML += '<p>' + object[1].id  + ' ' + object[1].id + '</p>';
        };
        request.send(params);
    }

    function addToMap(lat, lng, username) {
        marker = new google.maps.Marker({
            position: new google.maps.LatLng(lat, lng),
            title: username,
            icon: me_icon
        });
        marker.setMap(map);
    }

    function reqListener () {
        console.log("Something is happening");

        // Step 5: do something with the response data...
        console.log(request.responseText);
        console.log(this.responseText);
    }

    </script>

</head>
    <body onload="myMap()">

    <h1 id="title">Black Car Service</h1>

    <div id="map"></div>

    <div id="location"></div>

</body>
</html>
